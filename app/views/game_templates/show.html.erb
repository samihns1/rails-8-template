<style>
  .game-layout {
    max-width: 900px;
    margin: 1rem auto 2.5rem;
  }

  .game-header {
    margin-bottom: 1.25rem;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 0.75rem;
  }

  .game-header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
  }

  .game-header-sub {
    margin-top: 0.3rem;
    font-size: 0.95rem;
    color: #6b7280;
  }

  .section-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 16px 20px 18px;
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    margin-bottom: 1rem;
  }

  .section-card h3 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    font-size: 1.2rem;
    font-weight: 600;
    color: #111827;
  }

  .info-grid {
    display: grid;
    grid-template-columns: 180px auto;
    row-gap: 8px;
    column-gap: 8px;
    font-size: 0.95rem;
  }

  .info-grid dt {
    font-weight: 600;
    color: #4b5563;
  }

  .info-grid dd {
    margin: 0;
    color: #111827;
  }

  .btn {
    display: inline-block;
    padding: 0.55rem 1.1rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    text-decoration: none;
    text-align: center;
    transition: background-color 0.2s ease, transform 0.1s ease, filter 0.2s ease, opacity 0.1s ease;
  }

  .btn-primary {
    background: #3b82f6;
    color: #ffffff;
    box-shadow: 0 3px 10px rgba(37, 99, 235, 0.35);
  }

  .btn-primary:hover {
    filter: brightness(0.9);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: #e5e7eb;
    color: #111827;
  }

  .btn-secondary:hover {
    filter: brightness(0.95);
    transform: translateY(-1px);
  }

  .btn-danger {
    background: #ef4444;
    color: #ffffff;
  }

  .btn-danger:hover {
    filter: brightness(0.9);
    transform: translateY(-2px);
  }

  .btn[disabled],
  .btn:disabled {
    opacity: 0.6;
    cursor: default;
    box-shadow: none;
    transform: none;
    filter: none;
  }

  .helper-text {
    font-size: 0.9rem;
    color: #4b5563;
  }

  .helper-text-muted {
    font-size: 0.9rem;
    color: #6b7280;
  }

  .score-list {
    list-style: none;
    padding: 0;
    margin: 0.25rem 0 0;
  }

  .score-list li {
    padding: 0.25rem 0;
    font-size: 0.95rem;
  }

  .table-row {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .table-meta {
    font-size: 0.9rem;
    color: #374151;
  }

  .hand-list {
    display: flex;
    gap: 1rem;
    list-style: none;
    padding: 0;
    margin: 0.25rem 0 0;
    flex-wrap: wrap;
  }

  .hand-item {
    text-align: center;
    min-width: 70px;
  }

  .hand-item form {
    margin-top: 0.4rem;
  }

  .status-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.2rem 0.55rem;
    border-radius: 999px;
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .status-waiting {
    background: #fef3c7;
    color: #92400e;
  }

  .status-started {
    background: #dcfce7;
    color: #166534;
  }

  .status-finished {
    background: #e5e7eb;
    color: #374151;
  }

  .danger-link {
    color: #ef4444;
    text-decoration: none;
    font-weight: 500;
  }

  .danger-link:hover {
    text-decoration: underline;
  }

  .btn-delete {
  background: transparent !important;
  color: #b91c1c !important;
  border: 2px solid #f78c8cff !important;
  padding: 0.25rem 0.65rem !important;
  font-size: 0.8rem !important;
  border-radius: 999px !important;
  width: auto !important;
  display: inline-block !important;
  box-shadow: none !important;
  }

  .btn-delete:hover {
  background: #fdd8d8ff !important;
  color: #b91c1c !important;
  border-color: #f87171 !important;
  transform: translateY(-1px);
  }
</style>

<div class="game-layout">
  <div class="game-header">
    <h1>
      <% if @the_game.name.present? %>
        <%= @the_game.name %>
      <% else %>
        Game #<%= @the_game.id %>
      <% end %>
    </h1>
    <div class="game-header-sub">
      Code: <strong><%= @the_game.room_code %></strong>
      &nbsp;•&nbsp;
      <% status_class =
        case @the_game.status
        when 'started' then 'status-started'
        when 'finished' then 'status-finished'
        else 'status-waiting'
        end %>
      <span class="status-pill <%= status_class %>">
        <%= @the_game.status.capitalize %>
      </span>
      <dd>Creator: <strong><%= @the_game.creator&.username %></strong></dd>
      <dd>Players joined: <strong><%= @the_game.gameplayers.count %></strong> / <%= (@the_game.max_players || 2) %></dd>
    </div>
  </div>

  <div id="game-root"
    data-game-id="<%= @the_game.id %>"
    data-current-user-id="<%= current_user&.id || '' %>"
    data-is-creator="<%= (current_user && current_user.id == @the_game.creator_id) ? 'true' : 'false' %>"
    style="display:none"></div>

  <%
    all_hands_empty = @the_game.gameplayers.all? { |gp| gp.hand_cards_array.empty? }
    deck_empty = @the_game.deck_state_array.empty?
  %>

  <% if deck_empty && all_hands_empty %>
    <article class="section-card">
      <h3>Round complete — scores</h3>
      <% 
        last_round_stats = {}
        if @the_game.last_round_stats.present?
          begin
            last_round_stats = JSON.parse(@the_game.last_round_stats)
          rescue JSON::ParserError
            last_round_stats = {}
          end
        end
      %>
      <ul class="score-list">
        <% @the_game.gameplayers.order(:seat_number).each do |gp| %>
          <li>
            <strong>Player <%= gp.seat_number %>:</strong>
            <%= gp.user&.username %> —
            <strong><%= gp.score || 0 %></strong> points
            <% round_earned = last_round_stats[gp.user_id.to_s].to_i %>
            <% if round_earned > 0 %>
              <span class="round-majority-pill">+<%= round_earned %> points</span>
            <% end %>
          </li>
        <% end %>
      </ul>

      <% if current_user && current_user.id == @the_game.creator_id %>
        <div style="margin-top:0.75rem;">
          <form action="/start_next_round/<%= @the_game.id %>" method="post" style="display:inline;">
            <button type="submit" class="btn btn-primary">Start next round</button>
          </form>
        </div>
      <% else %>
        <div style="margin-top:0.75rem;" class="helper-text-muted">
          Waiting for the game creator to start the next round.
        </div>
      <% end %>
    </article>

    <% last_take = @the_game.moves.where(card_played: nil).order(created_at: :desc).first %>
    <% if last_take.present? %>
      <% prev_last = @the_game.moves.where(card_played: nil).order(created_at: :desc).second %>
      <% hand_moves =
      if prev_last
        @the_game.moves.where("created_at > ? AND created_at <= ?", prev_last.created_at, last_take.created_at).order(:created_at).to_a
      else
        @the_game.moves.where("created_at <= ?", last_take.created_at).order(:created_at).to_a
      end %>

      <style>
        .round-breakdown {
          margin-top: 1rem;
        }

        .round-breakdown-header {
          display: flex;
          justify-content: space-between;
          align-items: baseline;
          gap: 0.5rem;
          margin-bottom: 0.5rem;
        }

        .round-breakdown-header h3 {
          margin: 0;
          font-size: 1.15rem;
          font-weight: 600;
          color: #111827;
        }

        .round-breakdown-header span {
          font-size: 0.85rem;
          color: #6b7280;
        }

        .round-breakdown-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 0.95rem;
        }

        .round-breakdown-table thead th {
          padding: 0.6rem 0.5rem;
          border-bottom: 1px solid #e5e7eb;
          background: #f9fafb;
          color: #6b7280;
          font-weight: 600;
          white-space: nowrap;
        }

        .round-breakdown-table th.center,
        .round-breakdown-table td.center {
          text-align: center;
        }

        .round-breakdown-table th.right,
        .round-breakdown-table td.right {
          text-align: right;
        }

        .round-breakdown-table tbody tr:nth-child(even) {
          background: #f9fafb;
        }

        .round-breakdown-table tbody td {
          padding: 0.55rem 0.5rem;
          border-bottom: 1px solid #f3f4f6;
          color: #111827;
        }

        .round-breakdown-table tbody tr:last-child td {
          border-bottom: none;
        }

        .round-points {
          font-weight: 600;
        }

        .round-majority-pill {
          display: inline-flex;
          align-items: center;
          margin-left: 0.35rem;
          padding: 0.08rem 0.45rem;
          border-radius: 999px;
          background: #dcfce7;
          color: #166534;
          font-size: 0.7rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.04em;
        }
      </style>

      <article class="section-card round-breakdown">
        <div class="round-breakdown-header">
          <h3>Round breakdown</h3>
          <span>
            Last take by
            <strong><%= User.find_by(id: last_take.user_id)&.username || "N/A" %></strong>
          </span>
        </div>

        <table class="round-breakdown-table">
          <thead>
            <tr>
              <th>Player</th>
              <th class="center">Cards collected</th>
              <th class="center">Basras</th>
              <th class="right">Points earned</th>
            </tr>
          </thead>
          <tbody>
            <% active_players = @the_game.gameplayers.count %>
            <% majority_threshold = (52.0 / active_players).ceil + 1 %>

            <% @the_game.gameplayers.order(:seat_number).each do |gp| %>
              <% player_moves = hand_moves.select { |m| m.user_id == gp.user_id } %>
              <% basra_count = player_moves.count { |m| m.basra } %>

              <% captured_count = player_moves.reduce(0) do |acc, m|
                   begin
                     arr = JSON.parse(m.captured_cards.to_s)
                     card_count = arr.is_a?(Array) ? arr.length : 0
                     card_count += 1 if card_count > 0 && m.card_played.present?
                     acc + card_count
                   rescue JSON::ParserError, TypeError
                     acc
                   end
                 end %>

              <% points_from_moves = player_moves.sum { |m| (m.points_earned || 0).to_i } %>
              <% majority_bonus = captured_count >= majority_threshold ? 30 : 0 %>
              <% total_earned = points_from_moves + majority_bonus %>

              <tr>
                <td>
                  <%= gp.user&.username || "Player #{gp.seat_number}" %>
                </td>
                <td class="center"><%= captured_count %></td>
                <td class="center"><%= basra_count %></td>
                <td class="right">
                  <span class="round-points"><%= total_earned %></span>
                  <% if majority_bonus > 0 %>
                    <span class="round-majority-pill">+30 majority</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </article>
    <% end %>
  <% end %>

  <% if @the_game.status == 'started' %>

    <% if @the_game.moves.any? %>
      <% last_move = @the_game.moves.where.not(card_played: nil).order(created_at: :desc).first %>
      <% if last_move.present? %>
        <style>
          .last-move-alert {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
          }
          
          .last-move-alert h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: #1e40af;
          }
          
          .last-move-played {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
          }
          
          .last-move-captured {
            font-size: 0.95rem;
            color: #374151;
          }
          
          .card-mini {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            margin: 0 0.15rem;
            border-radius: 4px;
            background: white;
            border: 1px solid #e5e7eb;
            font-weight: 600;
            font-size: 0.85rem;
          }
          
          .card-mini.red {
            color: #dc2626;
          }
          
          .card-mini.black {
            color: #1f2937;
          }
          
          .basra-badge {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.15rem 0.5rem;
            background: #c9ebff;
            color: #164865;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
          }
        </style>
        
        <article class="last-move-alert">
          <% move_player = User.find_by(id: last_move.user_id) %>
          <% is_current_user = current_user && current_user.id == last_move.user_id %>
          
          <h4>
            <% if is_current_user %>
              You played
            <% else %>
              <%= move_player&.username || "Player" %> played
            <% end %>
          </h4>
          
          <div class="last-move-played">
            <strong>Played:</strong>
            <% card = last_move.card_played %>
            <% rank = card[0..-2] %>
            <% suit = card[-1] %>
            <% suit_symbol = {"H" => "♥", "D" => "♦", "C" => "♣", "S" => "♠"}[suit] %>
            <% card_color = (suit == "H" || suit == "D") ? "red" : "black" %>
            <span class="card-mini <%= card_color %>"><%= rank %><%= suit_symbol %></span>
            <% if last_move.basra %>
              <span class="basra-badge">Basra!</span>
            <% end %>
          </div>
          
          <% captured_cards = JSON.parse(last_move.captured_cards || "[]") rescue [] %>
          <% if captured_cards.any? %>
            <div class="last-move-captured">
              <strong>Captured:</strong>
              <% captured_cards.each do |captured_card| %>
                <% c_rank = captured_card[0..-2] %>
                <% c_suit = captured_card[-1] %>
                <% c_suit_symbol = {"H" => "♥", "D" => "♦", "C" => "♣", "S" => "♠"}[c_suit] %>
                <% c_card_color = (c_suit == "H" || c_suit == "D") ? "red" : "black" %>
                <span class="card-mini <%= c_card_color %>"><%= c_rank %><%= c_suit_symbol %></span>
              <% end %>
            </div>
          <% else %>
            <div class="last-move-captured">
              <strong>Captured:</strong> <span style="color: #9ca3af;">No cards captured</span>
            </div>
          <% end %>
        </article>
      <% end %>
    <% end %>
  <% end %>

  <% if @the_game.status != 'started' && @the_game.moves.count == 0 %>
    <article class="section-card">

      <% if current_user && @current_gameplayer.nil? && current_user.id != @the_game.creator_id %>
      <% elsif @current_gameplayer.present? %>
        <div style="margin-top:0.5rem; color: green; font-size:0.95rem;">
          You have joined as seat <%= @current_gameplayer.seat_number %>.
        </div>
      <% end %>

      <h3>Game status</h3>
      <% if current_user && current_user.id == @the_game.creator_id %>
        <% players_count = @the_game.gameplayers.count %>
        <div id="start-controls" style="margin-top:0.5rem;">
          <div id="start-enabled" style="display: <%= players_count >= 2 ? 'inline' : 'none' %>;">
            <form action="/start_game/<%= @the_game.id %>" method="post" style="display:inline;">
              <button type="submit" class="btn btn-primary">Start game</button>
            </form>
          </div>

          <div id="start-disabled" style="display: <%= players_count < 2 ? 'inline' : 'none' %>;">
            <form style="display:inline;">
              <button type="button" class="btn btn-primary" disabled>Start game</button>
              <span class="helper-text" style="margin-left:0.5rem;">
                Need at least 2 players to start (currently <%= players_count %>).
              </span>
            </form>
          </div>
        </div>
      <% else %>
        <p class="helper-text-muted" style="margin-top:0.5rem;">
          Waiting for host to start the game.
        </p>
      <% end %>
    </article>
  <% end %>

  <% if @the_game.status != 'started' && @the_game.moves.count == 0 && current_user.id == @the_game.creator_id %>

  <% else %>


    <% if @the_game.status == 'started' && !(deck_empty && all_hands_empty) %>
      <article class="section-card">
        <h3>Table</h3>
        <% table = @the_game.table_cards_array %>
        <div class="table-row">
          <% if table.empty? %>
            <div class="card-back">(no cards)</div>
          <% else %>
            <% table.each do |c| %>
              <div class="<%= card_css_class(c) %>"><%= card_display_name(c) %></div>
            <% end %>
          <% end %>

          <div class="table-meta">
            Deck: <strong><%= @the_game.deck_state_array.length %></strong> cards
          </div>
        </div>
      </article>
    <% end %>

    <% if current_user && @current_gameplayer.present? && @the_game.status == 'started' && !(deck_empty && all_hands_empty) %>
      <article class="section-card">
        <h3>Your hand</h3>

        <% hand = @current_gameplayer.hand_cards_array %>

        <% if hand.empty? %>
          <p class="helper-text-muted">You have no cards in hand.</p>
        <% else %>
          <ul class="hand-list">
            <% 4.times do |i| %>
              <% card = hand[i] %>
              <li class="hand-item">
                <span class="<%= card_css_class(card) %>"><%= card_display_name(card) %></span>
                <% if card.present? && current_user.id == @the_game.current_player_id %>
                  <form action="/insert_move" method="post">
                    <input type="hidden" name="query_game_id" value="<%= @the_game.id %>">
                    <input type="hidden" name="query_card_played" value="<%= card %>">
                    <button type="submit" class="btn btn-primary">Play</button>
                  </form>
                <% end %>
              </li>
            <% end %>
          </ul>

          <% if current_user.id != @the_game.current_player_id %>
            <% other = User.find_by(id: @the_game.current_player_id) %>
            <div style="margin-top:0.5rem;" class="helper-text-muted">
              Waiting for <%= other ? other.username : 'player' %>'s turn
            </div>
          <% end %>
        <% end %>
      </article>
    <% end %>
  <% end %>

  <% if current_user && current_user.id == @the_game.creator_id %>
    <article class="section-card" style="text-align:right;">
      <form action="/delete_game/<%= @the_game.id %>" method="get" style="display:inline;">
        <button type="submit" class="btn btn-delete">
          Delete game
        </button>
      </form>
    </article>
  <% end %>
</div>

<script>
  (function() {
    const gameId = <%= @the_game.id %>;
    const gameRoot = document.getElementById('game-root');
    const isCreator = gameRoot ? gameRoot.dataset.isCreator === 'true' : false;
    let lastFingerprint = null;

    async function poll() {
      try {
        const res = await fetch(`/games/${gameId}/state`);
        
        if (res.status === 404 || !res.ok) {
          console.log('Game deleted detected (status:', res.status, ')');
          localStorage.setItem('gameDeletedAlert', 'Game was deleted.');
          localStorage.setItem('gameDeletedWasCreator', isCreator ? 'true' : 'false');
          window.location.href = '/';
          return;
        }
        
        const json = await res.json();
        
        if (json.error === 'not_found') {
          console.log('Game deleted detected (not_found error)');
          localStorage.setItem('gameDeletedAlert', 'Game was deleted.');
          localStorage.setItem('gameDeletedWasCreator', isCreator ? 'true' : 'false');
          window.location.href = '/';
          return;
        }

        try {
          if (typeof updateStartControls === 'function') {
            updateStartControls((json.players || []).length);
          }
        } catch (e) {
          console.debug('start-controls update failed', e);
        }

        const fingerprint = JSON.stringify({
          table: json.table_cards,
          deck_count: json.deck_count,
          current_player_id: json.current_player_id,
          hand: json.hand,
          status: json.status
        });

        if (lastFingerprint !== null && lastFingerprint !== fingerprint) {
          window.location.reload();
        }

        lastFingerprint = fingerprint;
      } catch (err) {
        console.debug('game poll error', err);

        try {
          const testRes = await fetch(`/games/${gameId}/state`);
          if (testRes.status === 404) {
            console.log('Game deleted detected (retry 404)');
            localStorage.setItem('gameDeletedAlert', 'Game was deleted.');
            localStorage.setItem('gameDeletedWasCreator', isCreator ? 'true' : 'false');
            window.location.href = '/';
          }
        } catch (e) {
          console.debug('retry failed', e);
        }
      }
    }

    poll();
    setInterval(poll, 2000);

    function updateStartControls(playersCount) {
      try {
        const gameRoot = document.getElementById('game-root');
        if (!gameRoot) return;
        const isCreator = gameRoot.dataset.isCreator === 'true';
        if (!isCreator) return;

        const enabled = document.getElementById('start-enabled');
        const disabled = document.getElementById('start-disabled');
        if (!enabled || !disabled) return;

        if (playersCount >= 2) {
          enabled.style.display = 'inline';
          disabled.style.display = 'none';
        } else {
          enabled.style.display = 'none';
          disabled.style.display = 'inline';
          const helper = disabled.querySelector('.helper-text');
          if (helper) {
            helper.textContent = `Need at least 2 players to start (currently ${playersCount}).`;
          }
        }
      } catch (e) {
        console.debug('updateStartControls error', e);
      }
    }
  })();
</script>
