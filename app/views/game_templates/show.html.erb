<h1>
  <% if @the_game.name.present? %>
    <%= @the_game.name %>
  <% else %>
    Game #<%= @the_game.id %>
  <% end %>
</h1>

<div id="game-root" data-game-id="<%= @the_game.id %>" style="display:none"></div>

<% if @the_game.status != 'started' && @the_game.moves.count == 0 %>
  <article>
    <dl style="display: grid; grid-template-columns: 200px auto; row-gap: 8px;">
      <dt>Game code</dt>
      <dd><%= @the_game.room_code %></dd>

      <dt>Creator</dt>
      <dd><%= @the_game.creator&.username %></dd>

      <dt>Status</dt>
      <dd><%= @the_game.status.capitalize %></dd>

      <dt>Players joined:</dt>
      <dd><strong><%= @the_game.gameplayers.count %></strong> / <%= (@the_game.max_players || 2) %></dd>
    </dl>
  </article>
<% end %>

<%
  all_hands_empty = @the_game.gameplayers.all? { |gp| gp.hand_cards_array.empty? }
  deck_empty = @the_game.deck_state_array.empty?
%>

<% if deck_empty && all_hands_empty %>
  <article>
    <h3>Round complete — scores</h3>
    <ul style="list-style:none; padding:0; margin-left:1.5rem;">
      <% @the_game.gameplayers.order(:seat_number).each do |gp| %>
        <li style="padding:0.25rem 0;"><strong>Player <%= gp.seat_number %>:</strong> <%= gp.user&.username %> — <strong><%= gp.score || 0 %></strong> points</li>
      <% end %>
    </ul>

    <% if current_user && current_user.id == @the_game.creator_id %>
      <div style="margin-top:0.5rem;">
        <form action="/start_next_round/<%= @the_game.id %>" method="post">
          <button type="submit">Start next round</button>
        </form>
      </div>
    <% else %>
      <div style="margin-top:0.5rem; color:#666;">Waiting for the game creator to start the next round.</div>
    <% end %>
  </article>
<% end %>

<% if @the_game.status == 'started' %>
  <article>
    <dt>Current turn</dt>
    <dd>
      <% current_player = User.find_by(id: @the_game.current_player_id) %>
      <%= current_player ? current_player.username : '—' %>
    </dd>
  </article>
<% end %>

<% if @the_game.status != 'started' %>
  <article>
    <h3>Game</h3>
    <% if current_user && current_user.id == @the_game.creator_id %>
      <% players_count = @the_game.gameplayers.count %>
      <div style="margin-top: 0.5rem;">
        <% if players_count >= 2 %>
          <form action="/start_game/<%= @the_game.id %>" method="post">
            <button type="submit">Start game</button>
          </form>
        <% else %>
          <form>
            <button type="button" disabled style="opacity:0.6;">Start game</button>
            <span style="color:#b00; margin-left:0.5rem;">Need at least 2 players to start (currently <%= players_count %>).</span>
          </form>
        <% end %>
      </div>
    <% else %>
      <dd>Waiting for host to start the game.</dd>
    <% end %>
  </article>
<% end %>

<% if @the_game.status != 'started' && @the_game.moves.count == 0 && current_user.id == @the_game.creator_id %>
  <article>
    <h3>Invite players</h3>

    <form action="/insert_invitation" method="post">
      <input type="hidden" name="query_game_id" value="<%= @the_game.id %>">

      <div>
        <label for="email_invite_box">Player email</label>
        <input type="text" id="email_invite_box" name="query_recipient_email">
      </div>

      <button type="submit">Send Invite</button>
    </form>

    <% if current_user && @current_gameplayer.nil? && current_user.id != @the_game.creator_id %>
      <form action="/join_game/<%= @the_game.id %>" method="post" style="margin-top: 0.5rem;">
        <button type="submit">Join this game</button>
      </form>
    <% elsif @current_gameplayer.present? %>
      <div style="margin-top:0.5rem; color: green;">You have joined as seat <%= @current_gameplayer.seat_number %>.</div>
    <% end %>
  </article>
<% else %>

  <% if @the_game.status == 'started' %>
    <article>
      <h3>Table</h3>
      <% table = @the_game.table_cards_array %>
      <div class="center-table" style="display:flex; gap:1rem; align-items:center;">
        <% if table.empty? %>
          <div class="card-back">(no cards)</div>
        <% else %>
          <% table.each do |c| %>
            <div class="<%= card_css_class(c) %>"><%= card_display_name(c) %></div>
          <% end %>
        <% end %>

        <div style="margin-left:1rem; font-size:0.9rem; color:#333;">
          Deck: <%= @the_game.deck_state_array.length %> cards
        </div>
      </div>
    </article>
  <% end %>

  <% if current_user && @current_gameplayer.present? && (@the_game.status == 'started' || current_user.id == @the_game.creator_id) %>
    <article>
      <h3>Your hand</h3>

      <% hand = @current_gameplayer.hand_cards_array %>

      <% if hand.empty? %>
        <p>You have no cards in hand.</p>
      <% else %>
        <ul style="display: flex; gap: 1rem; list-style: none; padding: 0;">
          <% 4.times do |i| %>
            <% card = hand[i] %>
            <li style="text-align: center;">
              <span class="<%= card_css_class(card) %>"><%= card_display_name(card) %></span>
              <% if card.present? && current_user.id == @the_game.current_player_id %>
                <form action="/insert_move" method="post" style="margin-top: 0.5rem;">
                  <input type="hidden" name="query_game_id" value="<%= @the_game.id %>">
                  <input type="hidden" name="query_card_played" value="<%= card %>">
                  <button type="submit">Play</button>
                </form>
              <% end %>
            </li>
          <% end %>
          <% if current_user.id != @the_game.current_player_id %>
            <% other = User.find_by(id: @the_game.current_player_id) %>
            <div style="margin-top:0.5rem; color:#666;">Waiting for <%= other ? other.username : 'player' %>'s turn</div>
          <% end %>
        </ul>
      <% end %>
    </article>
  <% end %>
<% end %>

<% if @the_game.status == 'started' %>
  <article>
    <dl style="display: grid; grid-template-columns: 150px auto; row-gap: 8px;">
      <dt>Game code</dt>
      <dd><%= @the_game.room_code %></dd>

      <dt>Creator</dt>
      <dd><%= @the_game.creator&.username %></dd>

      <dt>Status</dt>
      <dd><%= @the_game.status.capitalize %></dd>
    </dl>
    <div style="margin-top:0.5rem; color:#555; font-size:0.95rem;">
      Players joined: <strong><%= @the_game.gameplayers.count %></strong> / <%= (@the_game.max_players || 2) %>
    </div>
  </article>
<% end %>

<article>
  <div>
    <a href="/delete_game/<%= @the_game.id %>">
      Delete game
    </a>
  </div>
</article>

<script>
  (function() {
    const gameId = <%= @the_game.id %>;
    let lastFingerprint = null;

    async function poll() {
      try {
        const res = await fetch(`/games/${gameId}/state`);
        if (!res.ok) return;
        const json = await res.json();

        const fingerprint = JSON.stringify({
          table: json.table_cards,
          deck_count: json.deck_count,
          current_player_id: json.current_player_id,
          hand: json.hand
        });

        if (lastFingerprint !== null && lastFingerprint !== fingerprint) {
          window.location.reload();
        }

        lastFingerprint = fingerprint;
      } catch (err) {
        console.debug('game poll error', err);
      }
    }

    poll();
    setInterval(poll, 2000);
  })();
</script>
